!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.timesync=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";module.exports=emitter;function emitter(obj){var _callbacks={};obj.emit=function(event,data){var callbacks=_callbacks[event];callbacks&&callbacks.forEach(function(callback){return callback(data)})};obj.on=function(event,callback){var callbacks=_callbacks[event]||(_callbacks[event]=[]);callbacks.push(callback);return obj};obj.off=function(event,callback){if(callback){var callbacks=_callbacks[event];var index=callbacks.indexOf(callback);if(index!==-1){callbacks.splice(index,1)}if(callbacks.length===0){delete _callbacks[event]}}else{delete _callbacks[event]}return obj};obj.list=function(event){return _callbacks[event]||[]};return obj}},{}],2:[function(require,module,exports){"use strict";exports.compare=compare;exports.add=add;exports.sum=sum;exports.mean=mean;exports.std=std;exports.variance=variance;exports.median=median;function compare(a,b){return a>b?1:a<b?-1:0}function add(a,b){return a+b}function sum(arr){return arr.reduce(add)}function mean(arr){return sum(arr)/arr.length}function std(arr){return Math.sqrt(variance(arr))}function variance(arr){if(arr.length<2)return 0;var _mean=mean(arr);return arr.map(function(x){return Math.pow(x-_mean,2)}).reduce(add)/(arr.length-1)}function median(arr){if(arr.length<2)return arr[0];var sorted=arr.slice().sort(compare);if(sorted.length%2===0){return(arr[arr.length/2-1]+arr[arr.length/2])/2}else{return arr[(arr.length-1)/2]}}exports.__esModule=true},{}],3:[function(require,module,exports){"use strict";var _interopRequire=function(obj){return obj&&obj.__esModule?obj["default"]:obj};var _interopRequireWildcard=function(obj){return obj&&obj.__esModule?obj:{"default":obj}};exports.create=create;var util=_interopRequireWildcard(require("./util.js"));var stat=_interopRequireWildcard(require("./stat.js"));var emitter=_interopRequire(require("./emitter.js"));function create(options){var timesync={options:{interval:60*60*1e3,timeout:1e4,delay:1e3,repeat:5,peers:[],now:Date.now},offset:0,_timeout:null,inProgress:{},_isFirst:true,_running:true,send:function(to,data){throw new Error("Cannot execute abstract method send")},receive:function(from,data){if(data===undefined){data=from;from=undefined}if(data&&data.id in timesync.inProgress){timesync.inProgress[data.id](data.result)}else if(data&&data.id!==undefined){timesync.send(from,{jsonrpc:"2.0",id:data.id,result:timesync.now()})}},rpc:function(to,method,params){return new Promise(function(resolve,reject){var id=nextId();var timeout=setTimeout(function(){delete timesync.inProgress[id];reject(new Error("Timeout"))},timesync.options.timeout);timesync.inProgress[id]=function(data){clearTimeout(timeout);delete timesync.inProgress[id];resolve(data)};timesync.send(to,{jsonrpc:"2.0",id:id,method:method,params:params})})},sync:function(){timesync.emit("sync","start");var peers=timesync.options.peers;return Promise.all(peers.map(function(peer){return timesync._syncWithPeer(peer)})).then(function(offsets){if(offsets.length>0){timesync.offset=stat.mean(offsets);timesync.emit("change",timesync.offset)}timesync.emit("sync","end")})},_syncWithPeer:function(peer){function syncAndWait(){return timesync._getOffset(peer).then(function(result){return util.wait(timesync.options.delay).then(function(){return result})})}return util.repeat(syncAndWait,timesync.options.repeat).then(function(all){var results=all.filter(function(result){return result!==null});var roundtrips=results.map(function(result){return result.roundtrip});var limit=stat.median(roundtrips)+stat.std(roundtrips);var filtered=results.filter(function(result){return result.roundtrip<limit});var offsets=filtered.map(function(result){return result.offset});return offsets.length>0?stat.mean(offsets):null})},_getOffset:function(peer){var start=Date.now();return timesync.rpc(peer,"time").then(function(timestamp){var end=Date.now();var roundtrip=end-start;var offset=timestamp-end+roundtrip/2;if(timesync._isFirst){timesync._isFirst=false;timesync.offset=offset;timesync.emit("change",offset)}return{roundtrip:roundtrip,offset:offset}})["catch"](function(err){return null})},now:function(){return timesync.options.now()+timesync.offset},start:function(){timesync._running=true;timesync.sync().then(function(){timesync._timeout=setTimeout(function(){if(timesync._running){timesync.start()}},timesync.options.interval)})},stop:function(){clearTimeout(timesync._timeout);timesync._timeout=null;timesync._running=false}};if(options){for(var prop in options){if(options.hasOwnProperty(prop)){timesync.options[prop]=options[prop]}}}if(!Array.isArray(timesync.options.peers)){timesync.options.peers=[timesync.options.peers]}emitter(timesync);setTimeout(function(){if(timesync._running){timesync.start()}},0);return timesync}function nextId(){return _id++}var _id=0;exports.__esModule=true},{"./emitter.js":1,"./stat.js":2,"./util.js":4}],4:[function(require,module,exports){"use strict";exports.wait=wait;exports.repeat=repeat;function wait(delay){return new Promise(function(resolve){setTimeout(resolve,delay)})}function repeat(fn,times){return new Promise(function(resolve,reject){var count=0;var results=[];function recurse(){if(count<times){count++;fn().then(function(result){results.push(result);recurse()})}else{resolve(results)}}recurse()})}exports.__esModule=true},{}]},{},[3])(3)});